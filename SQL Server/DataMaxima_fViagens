USE FINANCA
;

DECLARE @datamaxima AS DATETIME
DECLARE @datamaximaanterior AS DATETIME
DECLARE @dataanterior AS DATETIME
SELECT @datamaxima = MAX([DATAATUALIZACAO]) FROM _fViagens
SELECT @datamaximaanterior = DATEADD(DAY, -1, @DATAMAXIMA)
SELECT @dataanterior = DATEADD(DAY, -2, @datamaxima)
;

WITH TBV_MAXIMA AS(
SELECT NUMEROMOV, DESCSTATUS, DATACRIACAO_A, DATACRIACAO_B, DATACRIACAO_C FROM _fViagens
WHERE DATAATUALIZACAO = @datamaxima)
, TBV_ANTERIOR AS(
SELECT NUMEROMOV, DESCSTATUS, DATACRIACAO_A, DATACRIACAO_B, DATACRIACAO_C FROM _fViagens
WHERE DATAATUALIZACAO = @datamaximaanterior)
, TBV_ANTERIOR2 AS(
SELECT NUMEROMOV, DESCSTATUS, DATACRIACAO_A, DATACRIACAO_B, DATACRIACAO_C FROM _fViagens
WHERE DATAATUALIZACAO = @dataanterior)

SELECT A.NUMEROMOV, A.DESCSTATUS AS 'DATAMAXIMA', B.DESCSTATUS AS 'DATAMAXIMAANTERIOR', C.DESCSTATUS AS 'DATAANTERIOR' 
, DATEDIFF(DAY, B.DATACRIACAO_C, A.DATACRIACAO_C) AS 'DIFERENCA_CRIACAO_MAXIMA_-1_39'
, DATEDIFF(DAY, C.DATACRIACAO_C, A.DATACRIACAO_C) AS 'DIFERENCA_CRIACAO_MAXIMA_-1_39_2'
FROM TBV_MAXIMA A
LEFT JOIN TBV_ANTERIOR B
ON A.NUMEROMOV = B.NUMEROMOV
LEFT JOIN TBV_ANTERIOR2 C
ON A.NUMEROMOV = C.NUMEROMOV
WHERE (A.DESCSTATUS <> B.DESCSTATUS OR A.DESCSTATUS <> C.DESCSTATUS OR B.DESCSTATUS <> C.DESCSTATUS) 
AND (B.DESCSTATUS IS NOT NULL OR C.DESCSTATUS IS NOT NULL)
ORDER BY A.NUMEROMOV ASC